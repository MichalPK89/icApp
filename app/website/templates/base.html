<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>App</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    {% load static %}
    <link rel="shortcut icon" type="image/png" href="{% static 'images/favicon.png' %}">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.7/css/dataTables.dataTables.min.css" />
    <script src="https://cdn.datatables.net/2.1.7/js/dataTables.min.js"></script>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <!-- DataTables Buttons CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.1.1/css/buttons.dataTables.min.css">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <!-- DataTables Buttons JS -->
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/buttons.html5.min.js"></script>


    {% block extra_styles %}
    <style>
        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        /* Hide the table content initially */
        #table-content {
            display: none;
        }
    </style>

    <style>
        /* Set the table to a constant height */
        .dataTables_wrapper {
            position: relative;
        }

        .dataTables_scrollBody {
            max-height: 400px; /* Set the max height for the scrollable content */
            overflow-y: scroll; /* Enable vertical scrolling */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        table.dataTable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white; /* Ensure the header has a background */
        }
    </style>

    {% endblock %}
</head>

<body>
    {% include 'navbar.html' %}
    <div class="container">
        </br>
        {% block content %}
        {% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    {% block extra_scripts %}
    <script>
        $(document).ready(function () {
            // Fetch data for the table
            fetchTableData("{% url 'get_vat_payers' %}", 'vat-payers-body');

            function fetchTableData(url, tableBodyId) {
                $('#loading-container').show();
                $('#table-content').hide();

                fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                    .then(response => response.json())
                    .then(data => {
                        $('#loading-container').hide();
                        $('#table-content').show();

                        let tbody = document.getElementById(tableBodyId);
                        tbody.innerHTML = '';  // Clear existing rows

                        // Create header dynamically based on the keys of the first data row
                        if (data.rows.length > 0) {
                            let headers = Object.keys(data.rows[0]);

                            // Clear existing thead and create new one
                            $('table.display thead').empty();

                            // Create and append header row
                            let thead = '<tr>';
                            headers.forEach(header => {
                                thead += `<th>${header}</th>`;
                            });
                            thead += '</tr>';
                            $('table.display thead').append(thead);

                            // Create filter row
                            let filterRow = '<tr id="filterTable">';
                            headers.forEach(header => {
                                filterRow += `<th><input type="text" placeholder="${header}" style="width: 100%"></th>`;
                            });
                            filterRow += '</tr>';
                            $('table.display thead').append(filterRow); // Append filter row

                            // Populate the table body with fetched data
                            data.rows.forEach(row => {
                                let tableRow = '<tr>';
                                headers.forEach(header => {
                                    tableRow += `<td>${row[header] || ''}</td>`;
                                });
                                tableRow += '</tr>';
                                tbody.innerHTML += tableRow;
                            });
                        }

                        // Initialize DataTable with export options
                        const newTable = $('table.display').DataTable({
                            responsive: true,
                            scrollY: '500px',  // Set table height
                            scrollCollapse: true,  // Allow the table to shrink below this height if there is less data
                            paging: true,  // Enable paging
                            autoWidth: false,
                            dom: 'Bfrtip',  // Adds button container for export options
                            buttons: [
                                {
                                    extend: 'csvHtml5',
                                    text: 'Export CSV',
                                    bom: true,  // Include UTF-8 BOM for encoding
                                    filename: 'VatPayersData',
                                },
                                {
                                    extend: 'excelHtml5',
                                    text: 'Export Excel',
                                    filename: 'VatPayersData',
                                }
                            ]
                        });

                        // Filter functionality for each column
                        $('#filterTable input').each(function (index) {
                            $(this).on('keyup change', function () {
                                const filterValue = this.value;

                                // If the value is empty, reset the search
                                if (filterValue === '') {
                                    newTable.column(index).search('').draw();
                                } else {
                                    // Check if the column is numeric or a date
                                    const columnData = newTable.column(index).data();

                                    if (isDateColumn(index) && filterValue) {
                                        // Handle date filtering with <= or >=
                                        newTable.column(index).search(filterValue).draw();
                                    } else if (!isNaN(filterValue) && filterValue) {
                                        // Handle numeric filtering with <, >, <=, >=
                                        newTable.column(index).search(filterValue, true, false).draw();
                                    } else {
                                        // Default behavior for text
                                        newTable.column(index).search(filterValue).draw();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            function isDateColumn(index) {
                // You can adjust the logic here to match your specific date columns based on the index
                // Assuming the date columns are the last two in your headers
                return index === 8 || index === 9; // Adjust these indexes as necessary
            }
        });

    </script>

    {% endblock %}

</body>
</html>
